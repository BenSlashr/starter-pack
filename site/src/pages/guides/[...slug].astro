---
import '@/styles/global.css';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
import Footer from '@/components/Footer.astro';
import CrossLinks from '@/components/CrossLinks.astro';
import ReadingProgressBar from '@/components/ReadingProgressBar.astro';
import SocialShare from '@/components/SocialShare.astro';
import TableOfContents from '@/components/TableOfContents.astro';
import FAQSection from '@/components/FAQSection.astro';
import AuthorBio from '@/components/AuthorBio.astro';
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { FAQS } from '@/data/faqs';
import { getLinksForGuide } from '@/data/internal-links';

export async function getStaticPaths() {
  const now = new Date();
  const allPages = await getCollection('guides', ({ data }) =>
    !data.pubDate || data.pubDate.valueOf() <= now.valueOf()
  );
  return allPages.map((entry) => {
    let slug = entry.id;
    if (slug === 'index') slug = '';
    else if (slug.endsWith('/index')) slug = slug.slice(0, -'/index'.length);
    return {
      params: { slug: slug || undefined },
      props: { entry, allPages },
    };
  });
}

interface Props {
  entry: CollectionEntry<'guides'>;
  allPages: CollectionEntry<'guides'>[];
}

const { entry, allPages } = Astro.props;
const { Content, headings } = await render(entry);

// Get sibling guides for navigation
const siblings = allPages
  .filter((p) => p.data.parent === entry.data.parent && p.data.type === 'guide')
  .sort((a, b) => a.data.order - b.data.order);

// Get children if this is a hub
const children = allPages
  .filter((p) => p.data.parent === entry.id.replace(/\/index$/, '') && p.data.type === 'guide')
  .sort((a, b) => a.data.order - b.data.order);

const isHub = entry.data.type === 'hub';

// Build breadcrumb
const parentHub = entry.data.parent
  ? allPages.find((p) => p.id === `${entry.data.parent}/index` || p.id === entry.data.parent)
  : null;

const faqItems = FAQS[entry.id] ?? [];
const showToc = !isHub && headings.filter(h => h.depth === 2 || h.depth === 3).length >= 3;

const crossLinkGroups = getLinksForGuide(entry.data.branch);
---

<BaseLayout
  title={`${entry.data.title} | MySite`}
  description={entry.data.description}
  ogImage={entry.data.image}
  ogImageAlt={entry.data.title}
  ogType={entry.data.type === 'guide' ? 'article' : 'website'}
  articleMeta={entry.data.type === 'guide' && entry.data.pubDate ? {
    publishedTime: new Date(entry.data.pubDate).toISOString(),
    modifiedTime: new Date(entry.data.pubDate).toISOString(),
  } : undefined}
>
  {entry.data.type === 'guide' && <ReadingProgressBar />}
  <Navbar />

  <main id="main-content" class="pt-32 pb-16">
    <div class={`mx-auto px-4 sm:px-6 lg:px-8 ${showToc ? 'max-w-4xl' : 'max-w-3xl'}`}>
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-text-muted mb-8" aria-label="Fil d'ariane">
        <a href="/" class="hover:text-primary transition-colors cursor-pointer">Accueil</a>
        <span>/</span>
        <a href="/guides" class="hover:text-primary transition-colors cursor-pointer">Guides</a>
        {parentHub && (
          <>
            <span>/</span>
            <a href={`/guides/${parentHub.id.replace(/\/index$/, '')}`} class="hover:text-primary transition-colors cursor-pointer">
              {parentHub.data.title}
            </a>
          </>
        )}
        {!isHub && (
          <>
            <span>/</span>
            <span class="text-text-secondary">{entry.data.title}</span>
          </>
        )}
      </nav>

      <!-- Header -->
      <header class="mb-10">
        {entry.data.readingTime && (
          <span class="text-xs text-text-muted mb-4 block">{entry.data.readingTime} de lecture</span>
        )}

        <h1 class="font-display font-800 text-display leading-[1.1] mb-4 tracking-tight">
          {entry.data.title}
        </h1>

        <p class="text-body-lg text-text-secondary leading-relaxed mb-6">
          {entry.data.description}
        </p>

        {!isHub && (
          <div class="flex items-center justify-between gap-4 text-sm text-text-muted border-t border-border pt-4">
            <span>{entry.data.readingTime} de lecture</span>
            <SocialShare title={entry.data.title} url={`/guides/${entry.id}`} />
          </div>
        )}
      </header>

      <!-- Hero Image -->
      {entry.data.image && (
        <div class="mb-10 rounded-card overflow-hidden border border-border">
          <img src={entry.data.image} alt={entry.data.title} width="1200" height="675" class="w-full h-auto object-cover aspect-video" loading="eager" fetchpriority="high" />
        </div>
      )}

      <!-- Children guides (if hub) -->
      {isHub && children.length > 0 && (
        <div class="mb-10 p-6 rounded-card border border-border bg-surface-raised/30">
          <h2 class="font-display font-600 text-body-lg text-text-primary mb-4">Articles de cette section</h2>
          <div class="space-y-2">
            {children.map((child, i) => (
              <a
                href={`/guides/${child.id}`}
                class="flex items-center gap-3 px-4 py-3 rounded-lg border border-border hover:border-primary/30 transition-all cursor-pointer group"
              >
                <span class="w-6 h-6 rounded-full bg-primary/10 text-primary text-xs font-semibold flex items-center justify-center flex-shrink-0">
                  {i + 1}
                </span>
                <div>
                  <p class="text-sm font-medium text-text-primary group-hover:text-primary transition-colors">{child.data.title}</p>
                  <p class="text-xs text-text-muted">{child.data.readingTime}</p>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Content + TOC grid -->
      <div class={showToc ? 'lg:grid lg:grid-cols-[1fr_220px] lg:gap-8' : ''}>
        <article class="prose-custom">
          <Content />
        </article>

        {showToc && (
          <aside>
            <TableOfContents headings={headings} />
          </aside>
        )}
      </div>

      <!-- Sibling navigation -->
      {!isHub && siblings.length > 1 && (
        <nav class="mt-12 flex justify-between gap-4">
          {(() => {
            const idx = siblings.findIndex((s) => s.id === entry.id);
            const prev = idx > 0 ? siblings[idx - 1] : null;
            const next = idx < siblings.length - 1 ? siblings[idx + 1] : null;
            return (
              <>
                {prev ? (
                  <a href={`/guides/${prev.id}`} class="flex-1 p-4 rounded-card border border-border hover:border-primary/30 transition-all cursor-pointer">
                    <span class="text-xs text-text-muted">&larr; Precedent</span>
                    <p class="text-sm font-medium text-text-primary">{prev.data.title}</p>
                  </a>
                ) : <div />}
                {next ? (
                  <a href={`/guides/${next.id}`} class="flex-1 p-4 rounded-card border border-border hover:border-primary/30 transition-all cursor-pointer text-right">
                    <span class="text-xs text-text-muted">Suivant &rarr;</span>
                    <p class="text-sm font-medium text-text-primary">{next.data.title}</p>
                  </a>
                ) : <div />}
              </>
            );
          })()}
        </nav>
      )}

      <!-- Cross-links -->
      <section class="mt-12">
        <CrossLinks groups={crossLinkGroups} />
      </section>

      <!-- FAQ -->
      {faqItems.length > 0 && (
        <div class="mt-12">
          <FAQSection items={faqItems} />
        </div>
      )}

      <!-- Author Bio (guides only) -->
      {!isHub && <AuthorBio />}

      <!-- Disclaimer -->
      {!isHub && (
        <div class="mt-8 p-4 rounded-card border border-border bg-surface-raised/20">
          <p class="text-xs text-text-muted leading-relaxed">
            {/* TODO: Replace with your disclaimer */}
            Cet article est publie a titre informatif. Faites vos propres recherches avant toute decision.
          </p>
        </div>
      )}
    </div>
  </main>

  <Footer />

  <!-- Schema.org BreadcrumbList -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Accueil", "item": Astro.site?.toString() },
      { "@type": "ListItem", "position": 2, "name": "Guides", "item": new URL('/guides', Astro.site).toString() },
      ...(parentHub ? [{ "@type": "ListItem", "position": 3, "name": parentHub.data.title, "item": new URL(`/guides/${parentHub.id.replace(/\/index$/, '')}`, Astro.site).toString() }] : []),
      ...(!isHub ? [{ "@type": "ListItem", "position": parentHub ? 4 : 3, "name": entry.data.title }] : []),
    ],
  })} />

  <!-- Schema.org Article -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": isHub ? "CollectionPage" : "Article",
    ...(isHub ? { "name": entry.data.title } : { "headline": entry.data.title }),
    "description": entry.data.description,
    ...(entry.data.pubDate && { "datePublished": new Date(entry.data.pubDate).toISOString() }),
    ...(entry.data.pubDate && { "dateModified": new Date(entry.data.pubDate).toISOString() }),
    ...(entry.data.image && {
      "image": {
        "@type": "ImageObject",
        "url": new URL(entry.data.image, Astro.site).toString(),
        "width": 1200,
        "height": 675,
      },
    }),
    "publisher": {
      "@type": "Organization",
      "name": "MySite",
      "url": Astro.site?.toString(),
      "logo": {
        "@type": "ImageObject",
        "url": new URL('/logo-icon.svg', Astro.site).toString(),
      },
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": new URL(`/guides/${entry.id}`, Astro.site).toString(),
    },
  })} />
</BaseLayout>
